name: BoBaShop CI Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare lowercase safe image names
        id: names
        run: |
          OWNER_SAFE=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
          REPO_SAFE=$(basename "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]' | tr -cd 'a-z0-9-')
          echo "api_image=ghcr.io/${OWNER_SAFE}/${REPO_SAFE}-api:latest" >> $GITHUB_OUTPUT
          echo "web_image=ghcr.io/${OWNER_SAFE}/${REPO_SAFE}-web:latest" >> $GITHUB_OUTPUT
          echo "âœ… Using images:"
          echo "API -> ghcr.io/${OWNER_SAFE}/${REPO_SAFE}-api:latest"
          echo "WEB -> ghcr.io/${OWNER_SAFE}/${REPO_SAFE}-web:latest"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build API image
        run: |
          docker build -t "${{ steps.names.outputs.api_image }}" -f BobaShop.Api/Dockerfile .

      - name: Build Web image
        run: |
          docker build -t "${{ steps.names.outputs.web_image }}" -f BobaShop.Web/Dockerfile .

      - name: Smoke test (compose up on 8080/8081)
        run: |
          docker compose -f docker-compose.yml up -d
          sleep 15
          curl -k https://localhost:8080/api/v1/Drinks || true
          docker compose down

      - name: Push images to GHCR
        run: |
          docker push "${{ steps.names.outputs.api_image }}"
          docker push "${{ steps.names.outputs.web_image }}"
